#include "BSP.h"

int16_t I2S_ADCBuf[2048];
int16_t I2S_DACBuf[2048];
float fifo[4][1024];

float freq = 1000.0; 	//freq
uint32_t Wave_tick1 = 0;
uint32_t Wave_sum1 = 0;	//phase

extern I2C_HandleTypeDef hi2c1;
extern I2S_HandleTypeDef hi2s3;
extern void DSP_I2S_Callback(float* pt1, float* pt2, float* pt3, float* pt4, uint16_t offset);

const int16_t twiddleCoefQ15[] = {
0,147,295,442,589,736,883,1031,1178,1325,1472,1619,1766,1912,2059,2206,2352,2499,2645,2792,2938,3084,3230,3376,3522,3667,3813,3958,4103,4248,4393,4538,4682,4827,4971,5115,5258,5402,5545,5689,5832,5974,6117,6259,6401,6543,6684,6826,6967,7108,7248,7388,7528,7668,7807,7947,8085,8224,8362,8500,8637,8775,8912,9048,9184,9320,9456,9591,9726,9860,9994,10128,10261,10394,10527,10659,10791,10922,11053,11183,11314,11443,11572,11701,11830,11957,12085,12212,12338,12465,12590,12715,12840,12964,13088,13211,13334,13456,13578,13699,13819,13940,14059,14178,14297,14415,14532,14649,14766,14881,14997,15111,15225,15339,15452,15564,15676,15787,15898,16008,16117,16226,16334,16442,16549,16655,16761,16866,16971,17074,17178,17280,17382,17483,17584,17684,17783,17881,17979,18076,18173,18269,18364,18458,18552,18645,18738,18829,18920,19011,19100,19189,19277,19364,19451,19537,19622,19706,19790,19873,19955,20037,20117,20197,20276,20355,20433,20509,20585,20661,20735,20809,20882,20954,21026,21096,21166,21235,21303,21371,21437,21503,21568,21632,21696,21758,21820,21881,21941,22000,22059,22116,22173,22229,22284,22338,22392,22444,22496,22547,22597,22646,22695,22742,22789,22834,22879,22923,22967,23009,23050,23091,23131,23169,23207,23245,23281,23316,23351,23384,23417,23449,23480,23510,23539,23567,23595,23621,23647,23671,23695,23718,23740,23761,23782,23801,23820,23837,23854,23870,23884,23898,23912,23924,23935,23945,23955,23963,23971,23978,23984,23989,23993,23996,23998,24000,24000,24000,23998,23996,23993,23989,23984,23978,23971,23963,23955,23945,23935,23924,23912,23898,23884,23870,23854,23837,23820,23801,23782,23761,23740,23718,23695,23671,23647,23621,23595,23567,23539,23510,23480,23449,23417,23384,23351,23316,23281,23245,23207,23169,23131,23091,23050,23009,22967,22923,22879,22834,22789,22742,22695,22646,22597,22547,22496,22444,22392,22338,22284,22229,22173,22116,22059,22000,21941,21881,21820,21758,21696,21632,21568,21503,21437,21371,21303,21235,21166,21096,21026,20954,20882,20809,20735,20661,20585,20509,20433,20355,20276,20197,20117,20037,19955,19873,19790,19706,19622,19537,19451,19364,19277,19189,19100,19011,18920,18829,18738,18645,18552,18458,18364,18269,18173,18076,17979,17881,17783,17684,17584,17483,17382,17280,17178,17074,16971,16866,16761,16655,16549,16442,16334,16226,16117,16008,15898,15787,15676,15564,15452,15339,15225,15111,14997,14881,14766,14649,14532,14415,14297,14178,14059,13940,13819,13699,13578,13456,13334,13211,13088,12964,12840,12715,12590,12465,12338,12212,12085,11957,11830,11701,11572,11443,11314,11183,11053,10922,10791,10659,10527,10394,10261,10128,9994,9860,9726,9591,9456,9320,9184,9048,8912,8775,8637,8500,8362,8224,8085,7947,7807,7668,7528,7388,7248,7108,6967,6826,6684,6543,6401,6259,6117,5974,5832,5689,5545,5402,5258,5115,4971,4827,4682,4538,4393,4248,4103,3958,3813,3667,3522,3376,3230,3084,2938,2792,2645,2499,2352,2206,2059,1912,1766,1619,1472,1325,1178,1031,883,736,589,442,295,147,0,-147,-295,-442,-589,-736,-883,-1031,-1178,-1325,-1472,-1619,-1766,-1912,-2059,-2206,-2352,-2499,-2645,-2792,-2938,-3084,-3230,-3376,-3522,-3667,-3813,-3958,-4103,-4248,-4393,-4538,-4682,-4827,-4971,-5115,-5258,-5402,-5545,-5689,-5832,-5974,-6117,-6259,-6401,-6543,-6684,-6826,-6967,-7108,-7248,-7388,-7528,-7668,-7807,-7947,-8085,-8224,-8362,-8500,-8637,-8775,-8912,-9048,-9184,-9320,-9456,-9591,-9726,-9860,-9994,-10128,-10261,-10394,-10527,-10659,-10791,-10922,-11053,-11183,-11314,-11443,-11572,-11701,-11830,-11957,-12085,-12212,-12338,-12465,-12590,-12715,-12840,-12964,-13088,-13211,-13334,-13456,-13578,-13699,-13819,-13940,-14059,-14178,-14297,-14415,-14532,-14649,-14766,-14881,-14997,-15111,-15225,-15339,-15452,-15564,-15676,-15787,-15898,-16008,-16117,-16226,-16334,-16442,-16549,-16655,-16761,-16866,-16971,-17074,-17178,-17280,-17382,-17483,-17584,-17684,-17783,-17881,-17979,-18076,-18173,-18269,-18364,-18458,-18552,-18645,-18738,-18829,-18920,-19011,-19100,-19189,-19277,-19364,-19451,-19537,-19622,-19706,-19790,-19873,-19955,-20037,-20117,-20197,-20276,-20355,-20433,-20509,-20585,-20661,-20735,-20809,-20882,-20954,-21026,-21096,-21166,-21235,-21303,-21371,-21437,-21503,-21568,-21632,-21696,-21758,-21820,-21881,-21941,-22000,-22059,-22116,-22173,-22229,-22284,-22338,-22392,-22444,-22496,-22547,-22597,-22646,-22695,-22742,-22789,-22834,-22879,-22923,-22967,-23009,-23050,-23091,-23131,-23169,-23207,-23245,-23281,-23316,-23351,-23384,-23417,-23449,-23480,-23510,-23539,-23567,-23595,-23621,-23647,-23671,-23695,-23718,-23740,-23761,-23782,-23801,-23820,-23837,-23854,-23870,-23884,-23898,-23912,-23924,-23935,-23945,-23955,-23963,-23971,-23978,-23984,-23989,-23993,-23996,-23998,-24000,-24000,-24000,-23998,-23996,-23993,-23989,-23984,-23978,-23971,-23963,-23955,-23945,-23935,-23924,-23912,-23898,-23884,-23870,-23854,-23837,-23820,-23801,-23782,-23761,-23740,-23718,-23695,-23671,-23647,-23621,-23595,-23567,-23539,-23510,-23480,-23449,-23417,-23384,-23351,-23316,-23281,-23245,-23207,-23169,-23131,-23091,-23050,-23009,-22967,-22923,-22879,-22834,-22789,-22742,-22695,-22646,-22597,-22547,-22496,-22444,-22392,-22338,-22284,-22229,-22173,-22116,-22059,-22000,-21941,-21881,-21820,-21758,-21696,-21632,-21568,-21503,-21437,-21371,-21303,-21235,-21166,-21096,-21026,-20954,-20882,-20809,-20735,-20661,-20585,-20509,-20433,-20355,-20276,-20197,-20117,-20037,-19955,-19873,-19790,-19706,-19622,-19537,-19451,-19364,-19277,-19189,-19100,-19011,-18920,-18829,-18738,-18645,-18552,-18458,-18364,-18269,-18173,-18076,-17979,-17881,-17783,-17684,-17584,-17483,-17382,-17280,-17178,-17074,-16971,-16866,-16761,-16655,-16549,-16442,-16334,-16226,-16117,-16008,-15898,-15787,-15676,-15564,-15452,-15339,-15225,-15111,-14997,-14881,-14766,-14649,-14532,-14415,-14297,-14178,-14059,-13940,-13819,-13699,-13578,-13456,-13334,-13211,-13088,-12964,-12840,-12715,-12590,-12465,-12338,-12212,-12085,-11957,-11830,-11701,-11572,-11443,-11314,-11183,-11053,-10922,-10791,-10659,-10527,-10394,-10261,-10128,-9994,-9860,-9726,-9591,-9456,-9320,-9184,-9048,-8912,-8775,-8637,-8500,-8362,-8224,-8085,-7947,-7807,-7668,-7528,-7388,-7248,-7108,-6967,-6826,-6684,-6543,-6401,-6259,-6117,-5974,-5832,-5689,-5545,-5402,-5258,-5115,-4971,-4827,-4682,-4538,-4393,-4248,-4103,-3958,-3813,-3667,-3522,-3376,-3230,-3084,-2938,-2792,-2645,-2499,-2352,-2206,-2059,-1912,-1766,-1619,-1472,-1325,-1178,-1031,-883,-736,-589,-442,-295,-147
};
const float twiddleCoeff32[] = {
0.000000,0.006136,0.012272,0.018407,0.024541,0.030675,0.036807,0.042938,0.049068,0.055195,0.061321,0.067444,0.073565,0.079682,0.085797,0.091909,0.098017,0.104122,0.110222,0.116319,0.122411,0.128498,0.134581,0.140658,0.146730,0.152797,0.158858,0.164913,0.170962,0.177004,0.183040,0.189069,0.195090,0.201105,0.207111,0.213110,0.219101,0.225084,0.231058,0.237024,0.242980,0.248928,0.254866,0.260794,0.266713,0.272621,0.278520,0.284408,0.290285,0.296151,0.302006,0.307850,0.313682,0.319502,0.325310,0.331106,0.336890,0.342661,0.348419,0.354164,0.359895,0.365613,0.371317,0.377007,0.382683,0.388345,0.393992,0.399624,0.405241,0.410843,0.416430,0.422000,0.427555,0.433094,0.438616,0.444122,0.449611,0.455084,0.460539,0.465976,0.471397,0.476799,0.482184,0.487550,0.492898,0.498228,0.503538,0.508830,0.514103,0.519356,0.524590,0.529804,0.534998,0.540171,0.545325,0.550458,0.555570,0.560662,0.565732,0.570781,0.575808,0.580814,0.585798,0.590760,0.595699,0.600616,0.605511,0.610383,0.615232,0.620057,0.624859,0.629638,0.634393,0.639124,0.643832,0.648514,0.653173,0.657807,0.662416,0.667000,0.671559,0.676093,0.680601,0.685084,0.689541,0.693971,0.698376,0.702755,0.707107,0.711432,0.715731,0.720003,0.724247,0.728464,0.732654,0.736817,0.740951,0.745058,0.749136,0.753187,0.757209,0.761202,0.765167,0.769103,0.773010,0.776888,0.780737,0.784557,0.788346,0.792107,0.795837,0.799537,0.803208,0.806848,0.810457,0.814036,0.817585,0.821103,0.824589,0.828045,0.831470,0.834863,0.838225,0.841555,0.844854,0.848120,0.851355,0.854558,0.857729,0.860867,0.863973,0.867046,0.870087,0.873095,0.876070,0.879012,0.881921,0.884797,0.887640,0.890449,0.893224,0.895966,0.898674,0.901349,0.903989,0.906596,0.909168,0.911706,0.914210,0.916679,0.919114,0.921514,0.923880,0.926210,0.928506,0.930767,0.932993,0.935184,0.937339,0.939459,0.941544,0.943593,0.945607,0.947586,0.949528,0.951435,0.953306,0.955141,0.956940,0.958703,0.960431,0.962121,0.963776,0.965394,0.966976,0.968522,0.970031,0.971504,0.972940,0.974339,0.975702,0.977028,0.978317,0.979570,0.980785,0.981964,0.983105,0.984210,0.985278,0.986308,0.987301,0.988258,0.989177,0.990058,0.990903,0.991710,0.992480,0.993212,0.993907,0.994565,0.995185,0.995767,0.996313,0.996820,0.997290,0.997723,0.998118,0.998476,0.998795,0.999078,0.999322,0.999529,0.999699,0.999831,0.999925,0.999981,1.000000,0.999981,0.999925,0.999831,0.999699,0.999529,0.999322,0.999078,0.998795,0.998476,0.998118,0.997723,0.997290,0.996820,0.996313,0.995767,0.995185,0.994565,0.993907,0.993212,0.992480,0.991710,0.990903,0.990058,0.989177,0.988258,0.987301,0.986308,0.985278,0.984210,0.983105,0.981964,0.980785,0.979570,0.978317,0.977028,0.975702,0.974339,0.972940,0.971504,0.970031,0.968522,0.966976,0.965394,0.963776,0.962121,0.960431,0.958703,0.956940,0.955141,0.953306,0.951435,0.949528,0.947586,0.945607,0.943593,0.941544,0.939459,0.937339,0.935184,0.932993,0.930767,0.928506,0.926210,0.923880,0.921514,0.919114,0.916679,0.914210,0.911706,0.909168,0.906596,0.903989,0.901349,0.898674,0.895966,0.893224,0.890449,0.887640,0.884797,0.881921,0.879012,0.876070,0.873095,0.870087,0.867046,0.863973,0.860867,0.857729,0.854558,0.851355,0.848120,0.844854,0.841555,0.838225,0.834863,0.831470,0.828045,0.824589,0.821103,0.817585,0.814036,0.810457,0.806848,0.803208,0.799537,0.795837,0.792107,0.788346,0.784557,0.780737,0.776888,0.773010,0.769103,0.765167,0.761202,0.757209,0.753187,0.749136,0.745058,0.740951,0.736817,0.732654,0.728464,0.724247,0.720003,0.715731,0.711432,0.707107,0.702755,0.698376,0.693971,0.689541,0.685084,0.680601,0.676093,0.671559,0.667000,0.662416,0.657807,0.653173,0.648514,0.643832,0.639124,0.634393,0.629638,0.624859,0.620057,0.615232,0.610383,0.605511,0.600616,0.595699,0.590760,0.585798,0.580814,0.575808,0.570781,0.565732,0.560662,0.555570,0.550458,0.545325,0.540171,0.534998,0.529804,0.524590,0.519356,0.514103,0.508830,0.503538,0.498228,0.492898,0.487550,0.482184,0.476799,0.471397,0.465976,0.460539,0.455084,0.449611,0.444122,0.438616,0.433094,0.427555,0.422000,0.416430,0.410843,0.405241,0.399624,0.393992,0.388345,0.382683,0.377007,0.371317,0.365613,0.359895,0.354164,0.348419,0.342661,0.336890,0.331106,0.325310,0.319502,0.313682,0.307850,0.302006,0.296151,0.290285,0.284408,0.278520,0.272621,0.266713,0.260794,0.254866,0.248928,0.242980,0.237024,0.231058,0.225084,0.219101,0.213110,0.207111,0.201105,0.195090,0.189069,0.183040,0.177004,0.170962,0.164913,0.158858,0.152797,0.146730,0.140658,0.134581,0.128498,0.122411,0.116319,0.110222,0.104122,0.098017,0.091909,0.085797,0.079682,0.073565,0.067444,0.061321,0.055195,0.049068,0.042938,0.036807,0.030675,0.024541,0.018407,0.012272,0.006136,-0.000000,-0.006136,-0.012272,-0.018407,-0.024541,-0.030675,-0.036807,-0.042938,-0.049068,-0.055195,-0.061321,-0.067444,-0.073565,-0.079682,-0.085797,-0.091909,-0.098017,-0.104122,-0.110222,-0.116319,-0.122411,-0.128498,-0.134581,-0.140658,-0.146730,-0.152797,-0.158858,-0.164913,-0.170962,-0.177004,-0.183040,-0.189069,-0.195090,-0.201105,-0.207111,-0.213110,-0.219101,-0.225084,-0.231058,-0.237024,-0.242980,-0.248928,-0.254866,-0.260794,-0.266713,-0.272621,-0.278520,-0.284408,-0.290285,-0.296151,-0.302006,-0.307850,-0.313682,-0.319502,-0.325310,-0.331106,-0.336890,-0.342661,-0.348419,-0.354164,-0.359895,-0.365613,-0.371317,-0.377007,-0.382683,-0.388345,-0.393992,-0.399624,-0.405241,-0.410843,-0.416430,-0.422000,-0.427555,-0.433094,-0.438616,-0.444122,-0.449611,-0.455084,-0.460539,-0.465976,-0.471397,-0.476799,-0.482184,-0.487550,-0.492898,-0.498228,-0.503538,-0.508830,-0.514103,-0.519356,-0.524590,-0.529804,-0.534998,-0.540171,-0.545325,-0.550458,-0.555570,-0.560662,-0.565732,-0.570781,-0.575808,-0.580814,-0.585798,-0.590760,-0.595699,-0.600616,-0.605511,-0.610383,-0.615232,-0.620057,-0.624859,-0.629638,-0.634393,-0.639124,-0.643832,-0.648514,-0.653173,-0.657807,-0.662416,-0.667000,-0.671559,-0.676093,-0.680601,-0.685084,-0.689541,-0.693971,-0.698376,-0.702755,-0.707107,-0.711432,-0.715731,-0.720003,-0.724247,-0.728464,-0.732654,-0.736817,-0.740951,-0.745058,-0.749136,-0.753187,-0.757209,-0.761202,-0.765167,-0.769103,-0.773010,-0.776888,-0.780737,-0.784557,-0.788346,-0.792107,-0.795837,-0.799537,-0.803208,-0.806848,-0.810457,-0.814036,-0.817585,-0.821103,-0.824589,-0.828045,-0.831470,-0.834863,-0.838225,-0.841555,-0.844854,-0.848120,-0.851355,-0.854558,-0.857729,-0.860867,-0.863973,-0.867046,-0.870087,-0.873095,-0.876070,-0.879012,-0.881921,-0.884797,-0.887640,-0.890449,-0.893224,-0.895966,-0.898674,-0.901349,-0.903989,-0.906596,-0.909168,-0.911706,-0.914210,-0.916679,-0.919114,-0.921514,-0.923880,-0.926210,-0.928506,-0.930767,-0.932993,-0.935184,-0.937339,-0.939459,-0.941544,-0.943593,-0.945607,-0.947586,-0.949528,-0.951435,-0.953306,-0.955141,-0.956940,-0.958703,-0.960431,-0.962121,-0.963776,-0.965394,-0.966976,-0.968522,-0.970031,-0.971504,-0.972940,-0.974339,-0.975702,-0.977028,-0.978317,-0.979570,-0.980785,-0.981964,-0.983105,-0.984210,-0.985278,-0.986308,-0.987301,-0.988258,-0.989177,-0.990058,-0.990903,-0.991710,-0.992480,-0.993212,-0.993907,-0.994565,-0.995185,-0.995767,-0.996313,-0.996820,-0.997290,-0.997723,-0.998118,-0.998476,-0.998795,-0.999078,-0.999322,-0.999529,-0.999699,-0.999831,-0.999925,-0.999981,-1.000000,-0.999981,-0.999925,-0.999831,-0.999699,-0.999529,-0.999322,-0.999078,-0.998795,-0.998476,-0.998118,-0.997723,-0.997290,-0.996820,-0.996313,-0.995767,-0.995185,-0.994565,-0.993907,-0.993212,-0.992480,-0.991710,-0.990903,-0.990058,-0.989177,-0.988258,-0.987301,-0.986308,-0.985278,-0.984210,-0.983105,-0.981964,-0.980785,-0.979570,-0.978317,-0.977028,-0.975702,-0.974339,-0.972940,-0.971504,-0.970031,-0.968522,-0.966976,-0.965394,-0.963776,-0.962121,-0.960431,-0.958703,-0.956940,-0.955141,-0.953306,-0.951435,-0.949528,-0.947586,-0.945607,-0.943593,-0.941544,-0.939459,-0.937339,-0.935184,-0.932993,-0.930767,-0.928506,-0.926210,-0.923880,-0.921514,-0.919114,-0.916679,-0.914210,-0.911706,-0.909168,-0.906596,-0.903989,-0.901349,-0.898674,-0.895966,-0.893224,-0.890449,-0.887640,-0.884797,-0.881921,-0.879012,-0.876070,-0.873095,-0.870087,-0.867046,-0.863973,-0.860867,-0.857729,-0.854558,-0.851355,-0.848120,-0.844854,-0.841555,-0.838225,-0.834863,-0.831470,-0.828045,-0.824589,-0.821103,-0.817585,-0.814036,-0.810457,-0.806848,-0.803208,-0.799537,-0.795837,-0.792107,-0.788346,-0.784557,-0.780737,-0.776888,-0.773010,-0.769103,-0.765167,-0.761202,-0.757209,-0.753187,-0.749136,-0.745058,-0.740951,-0.736817,-0.732654,-0.728464,-0.724247,-0.720003,-0.715731,-0.711432,-0.707107,-0.702755,-0.698376,-0.693971,-0.689541,-0.685084,-0.680601,-0.676093,-0.671559,-0.667000,-0.662416,-0.657807,-0.653173,-0.648514,-0.643832,-0.639124,-0.634393,-0.629638,-0.624859,-0.620057,-0.615232,-0.610383,-0.605511,-0.600616,-0.595699,-0.590760,-0.585798,-0.580814,-0.575808,-0.570781,-0.565732,-0.560662,-0.555570,-0.550458,-0.545325,-0.540171,-0.534998,-0.529804,-0.524590,-0.519356,-0.514103,-0.508830,-0.503538,-0.498228,-0.492898,-0.487550,-0.482184,-0.476799,-0.471397,-0.465976,-0.460539,-0.455084,-0.449611,-0.444122,-0.438616,-0.433094,-0.427555,-0.422000,-0.416430,-0.410843,-0.405241,-0.399624,-0.393992,-0.388345,-0.382683,-0.377007,-0.371317,-0.365613,-0.359895,-0.354164,-0.348419,-0.342661,-0.336890,-0.331106,-0.325310,-0.319502,-0.313682,-0.307850,-0.302006,-0.296151,-0.290285,-0.284408,-0.278520,-0.272621,-0.266713,-0.260794,-0.254866,-0.248928,-0.242980,-0.237024,-0.231058,-0.225084,-0.219101,-0.213110,-0.207111,-0.201105,-0.195090,-0.189069,-0.183040,-0.177004,-0.170962,-0.164913,-0.158858,-0.152797,-0.146730,-0.140658,-0.134581,-0.128498,-0.122411,-0.116319,-0.110222,-0.104122,-0.098017,-0.091909,-0.085797,-0.079682,-0.073565,-0.067444,-0.061321,-0.055195,-0.049068,-0.042938,-0.036807,-0.030675,-0.024541,-0.018407,-0.012272,-0.006136
};

void BSP_Setfreq(float f)
{
	if(f>40000.0f)
		f = 40000.0f;
	if(f<0.0f)
		f = 0.0f;
	freq = f;
	Wave_tick1 = 42949.673f * f;
}

void HAL_I2S_TxHalfCpltCallback(I2S_HandleTypeDef *hi2s)
{
	uint16_t i,tmp;
	HAL_GPIO_WritePin(GPIOB,GPIO_PIN_12,GPIO_PIN_SET);
	for(i=1;i<=1024;i+=2)
	{
		tmp = Wave_sum1>>22;	//10bit
		Wave_sum1 += Wave_tick1;
		
		I2S_DACBuf[i] = twiddleCoefQ15[tmp];
		fifo[0][i>>1] = I2S_ADCBuf[i-1];
		fifo[1][i>>1] = I2S_ADCBuf[i];
		fifo[2][i>>1] = twiddleCoeff32[tmp];
		fifo[3][i>>1] = twiddleCoeff32[(tmp+768)&0x3ff];		//2^10=1024
	}
	
	DSP_I2S_Callback(fifo[0], fifo[1], fifo[2], fifo[3], 0);
	HAL_GPIO_WritePin(GPIOB,GPIO_PIN_12,GPIO_PIN_RESET);
}

void HAL_I2S_TxCpltCallback(I2S_HandleTypeDef *hi2s)
{
	uint16_t i,tmp;
	HAL_GPIO_WritePin(GPIOB,GPIO_PIN_12,GPIO_PIN_SET);
	for(i=1024+1;i<=2048;i+=2)
	{
		tmp = Wave_sum1>>22;
		Wave_sum1 += Wave_tick1;
		
		I2S_DACBuf[i] = twiddleCoefQ15[tmp];
		fifo[0][i>>1] = I2S_ADCBuf[i-1];
		fifo[1][i>>1] = I2S_ADCBuf[i];
		fifo[2][i>>1] = twiddleCoeff32[tmp];
		fifo[3][i>>1] = twiddleCoeff32[(tmp+768)&0x3ff];		//2^10=1024
	}
	
	DSP_I2S_Callback(fifo[0], fifo[1], fifo[2], fifo[3], 512);
	HAL_GPIO_WritePin(GPIOB,GPIO_PIN_12,GPIO_PIN_RESET);
}

const uint8_t CodecInit[][2] = 
{
	/* DAC Step */
	{0x00,0x00},	//Select Page 0
	{0x0b,0x81},	//NDAC = 1,Power up
	{0x0c,0x82},	//MDAC = 2,Power up
	{0x0d,0x00},	//DOSR = 128
	{0x0e,0x80},	//DOSR LSB
	{0x3c,0x01},	//PRB_P1
	
	/* ADC Step */
	{0x12,0x81},	//NADC = 1,Power up
	{0x13,0x82},	//MADC = 2,Power up
	{0x14,0x80},	//AOSR = 128
	{0x3d,0x01},	//PRB_R1
	
	/* Audio Interface */
	{0x1b,0x00},	//16bit,PTM_P4
	
	/* Power Step */
	{0x00,0x01},	//Select Page 1
	{0x01,0x08},	//Disabled weak connection of AVDD with DVDD
	{0x02,0x01},	//Analog Block Power up,AVDD LDO Power up
	//{0x0a,0x3b},	//Input Vcom = 0.9v,Output Vcom = 1.65v
	{0x0a,0x03},
	
	{0x03,0x00},	//DAC PTM mode		to PTM_P3/4
	{0x04,0x00},
	{0x3d,0x00},	//ADC PTM mode		to PTM_R4
	
//	{0x7b,0x01},	//REF settime			to 40ms
//	{0x14,0x25},	//HP settime			to	
	
	/* Input Step */
	{0x34,0x10},	//Route IN2L to LEFT_P with 10k
	{0x36,0x10},	//Route IN2R to LEFT_M with 10k
	{0x37,0x40},	//Route IN1R to RIGHT_P with 10k
	{0x39,0x10},	//Route IN1L to RIGHT_M with 10k
	
	{0x3b,0x00},	//Left  MicPGA not mute,gain to 0dB
	{0x3c,0x00},	//Right MicPGA not mute,gain to 0dB
	{0x53,0x00},	//Left  ADC Digital gain
	{0x54,0x00},	//Right ADC Digital gain
	
	/* Output Step */
	{0x0c,0x08},	//Route Left  DAC to HPL
	{0x0d,0x08},	//Route Right DAC to HPR
	{0x0e,0x08},	//Route Left  DAC to LOL
	{0x0f,0x08},	//Route Right DAC to LOR
	
	{0x10,0x00},	//HPL gain	to 0dB
	{0x11,0x00},	//HPR gain	to 0dB
	{0x12,0x08},	//LOL gain	to 0dB
	{0x13,0x08},	//LOR gain	to 0dB
	
	{0x16,0x75},
	{0x17,0x75},
	
	{0x09,0x3c},	//LOL,LOR,HPL,HPR,Power up
	
	/* Initial ok */
	{0x00,0x00},	//Select Page 0
	{0x3f,0xd6},	//L&R DAC Power up
	{0x40,0x00},	//L&R DAC not mute
	{0x51,0xc0},	//L&R ADC Power up
	{0x52,0x00},	//L&R ADC not mute
};

void BSP_CODEC_Init(void)
{
	uint16_t size = sizeof(CodecInit)/sizeof(CodecInit[0][0])/2;
	uint16_t i;

	//hi2s3.Instance->I2SPR = 0x0205;
	BSP_Setfreq(freq);
	
	/* TLV320AIC3204 reset */	
	Single_WriteI2C(0x00, 0x00);
	Single_WriteI2C(0x01, 0x01);
	
	HAL_Delay(5);
	
	for(i=0;i<size;i++)
			Single_WriteI2C(CodecInit[i][0],CodecInit[i][1]);
}

void BSP_CODEC_Start(void)
{
	HAL_I2SEx_TransmitReceive_DMA(&hi2s3,(uint16_t *)&I2S_DACBuf,(uint16_t *)&I2S_ADCBuf,2048);
}

void Single_WriteI2C(uint8_t REG_Address,uint8_t REG_data)
{
    uint8_t txData[2] = {REG_Address,REG_data};
    while(HAL_I2C_Master_Transmit(&hi2c1,I2C_ADDRESS,txData,2,100) != HAL_OK)
    {
        if(HAL_I2C_GetError(&hi2c1) != HAL_I2C_ERROR_AF)
        {}
    }
}
uint8_t Single_ReadI2C(uint8_t REG_Address)
{
    uint8_t REG_data;
    while(HAL_I2C_Master_Transmit(&hi2c1,I2C_ADDRESS,&REG_Address,1,100) != HAL_OK)
    {
        if(HAL_I2C_GetError(&hi2c1) != HAL_I2C_ERROR_AF)
        {}
    }
    
    if(HAL_I2C_Master_Receive(&hi2c1,I2C_ADDRESS+1,&REG_data,1,100) != HAL_OK)
    {
        if(HAL_I2C_GetError(&hi2c1) != HAL_I2C_ERROR_AF)
        {}
    }
    return REG_data;
}
