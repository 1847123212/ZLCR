#include "BSP.h"

int16_t I2S_ADCBuf[2048];
int16_t I2S_DACBuf[2048];
float fifo[4][1024];

float freq = 1000.0; 	//freq
uint32_t Wave_tick1 = 0;
uint32_t Wave_sum1 = 0;	//phase

extern I2C_HandleTypeDef hi2c1;
extern I2S_HandleTypeDef hi2s3;
extern void DSP_I2S_Callback(float* pt1, float* pt2, float* pt3, float* pt4, uint16_t offset);

const int16_t twiddleCoefQ15[] = {
0,147,295,442,589,736,883,1031,1178,1325,1472,1619,1766,1912,2059,2206,2352,2499,2645,2792,2938,3084,3230,3376,3522,3667,3813,3958,4103,4248,4393,4538,4682,4827,4971,5115,5258,5402,5545,5689,5832,5974,6117,6259,6401,6543,6684,6826,6967,7108,7248,7388,7528,7668,7807,7947,8085,8224,8362,8500,8637,8775,8912,9048,9184,9320,9456,9591,9726,9860,9994,10128,10261,10394,10527,10659,10791,10922,11053,11183,11314,11443,11572,11701,11830,11957,12085,12212,12338,12465,12590,12715,12840,12964,13088,13211,13334,13456,13578,13699,13819,13940,14059,14178,14297,14415,14532,14649,14766,14881,14997,15111,15225,15339,15452,15564,15676,15787,15898,16008,16117,16226,16334,16442,16549,16655,16761,16866,16971,17074,17178,17280,17382,17483,17584,17684,17783,17881,17979,18076,18173,18269,18364,18458,18552,18645,18738,18829,18920,19011,19100,19189,19277,19364,19451,19537,19622,19706,19790,19873,19955,20037,20117,20197,20276,20355,20433,20509,20585,20661,20735,20809,20882,20954,21026,21096,21166,21235,21303,21371,21437,21503,21568,21632,21696,21758,21820,21881,21941,22000,22059,22116,22173,22229,22284,22338,22392,22444,22496,22547,22597,22646,22695,22742,22789,22834,22879,22923,22967,23009,23050,23091,23131,23169,23207,23245,23281,23316,23351,23384,23417,23449,23480,23510,23539,23567,23595,23621,23647,23671,23695,23718,23740,23761,23782,23801,23820,23837,23854,23870,23884,23898,23912,23924,23935,23945,23955,23963,23971,23978,23984,23989,23993,23996,23998,24000,24000,24000,23998,23996,23993,23989,23984,23978,23971,23963,23955,23945,23935,23924,23912,23898,23884,23870,23854,23837,23820,23801,23782,23761,23740,23718,23695,23671,23647,23621,23595,23567,23539,23510,23480,23449,23417,23384,23351,23316,23281,23245,23207,23169,23131,23091,23050,23009,22967,22923,22879,22834,22789,22742,22695,22646,22597,22547,22496,22444,22392,22338,22284,22229,22173,22116,22059,22000,21941,21881,21820,21758,21696,21632,21568,21503,21437,21371,21303,21235,21166,21096,21026,20954,20882,20809,20735,20661,20585,20509,20433,20355,20276,20197,20117,20037,19955,19873,19790,19706,19622,19537,19451,19364,19277,19189,19100,19011,18920,18829,18738,18645,18552,18458,18364,18269,18173,18076,17979,17881,17783,17684,17584,17483,17382,17280,17178,17074,16971,16866,16761,16655,16549,16442,16334,16226,16117,16008,15898,15787,15676,15564,15452,15339,15225,15111,14997,14881,14766,14649,14532,14415,14297,14178,14059,13940,13819,13699,13578,13456,13334,13211,13088,12964,12840,12715,12590,12465,12338,12212,12085,11957,11830,11701,11572,11443,11314,11183,11053,10922,10791,10659,10527,10394,10261,10128,9994,9860,9726,9591,9456,9320,9184,9048,8912,8775,8637,8500,8362,8224,8085,7947,7807,7668,7528,7388,7248,7108,6967,6826,6684,6543,6401,6259,6117,5974,5832,5689,5545,5402,5258,5115,4971,4827,4682,4538,4393,4248,4103,3958,3813,3667,3522,3376,3230,3084,2938,2792,2645,2499,2352,2206,2059,1912,1766,1619,1472,1325,1178,1031,883,736,589,442,295,147,0,-147,-295,-442,-589,-736,-883,-1031,-1178,-1325,-1472,-1619,-1766,-1912,-2059,-2206,-2352,-2499,-2645,-2792,-2938,-3084,-3230,-3376,-3522,-3667,-3813,-3958,-4103,-4248,-4393,-4538,-4682,-4827,-4971,-5115,-5258,-5402,-5545,-5689,-5832,-5974,-6117,-6259,-6401,-6543,-6684,-6826,-6967,-7108,-7248,-7388,-7528,-7668,-7807,-7947,-8085,-8224,-8362,-8500,-8637,-8775,-8912,-9048,-9184,-9320,-9456,-9591,-9726,-9860,-9994,-10128,-10261,-10394,-10527,-10659,-10791,-10922,-11053,-11183,-11314,-11443,-11572,-11701,-11830,-11957,-12085,-12212,-12338,-12465,-12590,-12715,-12840,-12964,-13088,-13211,-13334,-13456,-13578,-13699,-13819,-13940,-14059,-14178,-14297,-14415,-14532,-14649,-14766,-14881,-14997,-15111,-15225,-15339,-15452,-15564,-15676,-15787,-15898,-16008,-16117,-16226,-16334,-16442,-16549,-16655,-16761,-16866,-16971,-17074,-17178,-17280,-17382,-17483,-17584,-17684,-17783,-17881,-17979,-18076,-18173,-18269,-18364,-18458,-18552,-18645,-18738,-18829,-18920,-19011,-19100,-19189,-19277,-19364,-19451,-19537,-19622,-19706,-19790,-19873,-19955,-20037,-20117,-20197,-20276,-20355,-20433,-20509,-20585,-20661,-20735,-20809,-20882,-20954,-21026,-21096,-21166,-21235,-21303,-21371,-21437,-21503,-21568,-21632,-21696,-21758,-21820,-21881,-21941,-22000,-22059,-22116,-22173,-22229,-22284,-22338,-22392,-22444,-22496,-22547,-22597,-22646,-22695,-22742,-22789,-22834,-22879,-22923,-22967,-23009,-23050,-23091,-23131,-23169,-23207,-23245,-23281,-23316,-23351,-23384,-23417,-23449,-23480,-23510,-23539,-23567,-23595,-23621,-23647,-23671,-23695,-23718,-23740,-23761,-23782,-23801,-23820,-23837,-23854,-23870,-23884,-23898,-23912,-23924,-23935,-23945,-23955,-23963,-23971,-23978,-23984,-23989,-23993,-23996,-23998,-24000,-24000,-24000,-23998,-23996,-23993,-23989,-23984,-23978,-23971,-23963,-23955,-23945,-23935,-23924,-23912,-23898,-23884,-23870,-23854,-23837,-23820,-23801,-23782,-23761,-23740,-23718,-23695,-23671,-23647,-23621,-23595,-23567,-23539,-23510,-23480,-23449,-23417,-23384,-23351,-23316,-23281,-23245,-23207,-23169,-23131,-23091,-23050,-23009,-22967,-22923,-22879,-22834,-22789,-22742,-22695,-22646,-22597,-22547,-22496,-22444,-22392,-22338,-22284,-22229,-22173,-22116,-22059,-22000,-21941,-21881,-21820,-21758,-21696,-21632,-21568,-21503,-21437,-21371,-21303,-21235,-21166,-21096,-21026,-20954,-20882,-20809,-20735,-20661,-20585,-20509,-20433,-20355,-20276,-20197,-20117,-20037,-19955,-19873,-19790,-19706,-19622,-19537,-19451,-19364,-19277,-19189,-19100,-19011,-18920,-18829,-18738,-18645,-18552,-18458,-18364,-18269,-18173,-18076,-17979,-17881,-17783,-17684,-17584,-17483,-17382,-17280,-17178,-17074,-16971,-16866,-16761,-16655,-16549,-16442,-16334,-16226,-16117,-16008,-15898,-15787,-15676,-15564,-15452,-15339,-15225,-15111,-14997,-14881,-14766,-14649,-14532,-14415,-14297,-14178,-14059,-13940,-13819,-13699,-13578,-13456,-13334,-13211,-13088,-12964,-12840,-12715,-12590,-12465,-12338,-12212,-12085,-11957,-11830,-11701,-11572,-11443,-11314,-11183,-11053,-10922,-10791,-10659,-10527,-10394,-10261,-10128,-9994,-9860,-9726,-9591,-9456,-9320,-9184,-9048,-8912,-8775,-8637,-8500,-8362,-8224,-8085,-7947,-7807,-7668,-7528,-7388,-7248,-7108,-6967,-6826,-6684,-6543,-6401,-6259,-6117,-5974,-5832,-5689,-5545,-5402,-5258,-5115,-4971,-4827,-4682,-4538,-4393,-4248,-4103,-3958,-3813,-3667,-3522,-3376,-3230,-3084,-2938,-2792,-2645,-2499,-2352,-2206,-2059,-1912,-1766,-1619,-1472,-1325,-1178,-1031,-883,-736,-589,-442,-295,-147
};
const float twiddleCoeff32[] = {
0.000000e+00,1.482388e-27,2.964720e-27,4.446941e-27,5.928994e-27,7.410824e-27,8.892375e-27,1.037359e-26,1.185442e-26,1.333480e-26,1.481467e-26,1.629399e-26,1.777270e-26,1.925073e-26,2.072805e-26,2.220458e-26,2.368027e-26,2.515508e-26,2.662894e-26,2.810179e-26,2.957359e-26,3.104427e-26,3.251378e-26,3.398207e-26,3.544908e-26,3.691476e-26,3.837905e-26,3.984189e-26,4.130323e-26,4.276302e-26,4.422119e-26,4.567770e-26,4.713249e-26,4.858551e-26,5.003670e-26,5.148600e-26,5.293337e-26,5.437874e-26,5.582207e-26,5.726329e-26,5.870236e-26,6.013922e-26,6.157381e-26,6.300608e-26,6.443599e-26,6.586347e-26,6.728846e-26,6.871093e-26,7.013080e-26,7.154804e-26,7.296258e-26,7.437438e-26,7.578337e-26,7.718952e-26,7.859275e-26,7.999303e-26,8.139030e-26,8.278450e-26,8.417558e-26,8.556350e-26,8.694819e-26,8.832961e-26,8.970771e-26,9.108243e-26,9.245371e-26,9.382152e-26,9.518580e-26,9.654649e-26,9.790354e-26,9.925692e-26,1.006065e-25,1.019524e-25,1.032944e-25,1.046325e-25,1.059667e-25,1.072969e-25,1.086230e-25,1.099451e-25,1.112630e-25,1.125768e-25,1.138862e-25,1.151915e-25,1.164923e-25,1.177888e-25,1.190809e-25,1.203684e-25,1.216514e-25,1.229299e-25,1.242037e-25,1.254729e-25,1.267373e-25,1.279970e-25,1.292518e-25,1.305018e-25,1.317468e-25,1.329869e-25,1.342220e-25,1.354520e-25,1.366770e-25,1.378967e-25,1.391113e-25,1.403207e-25,1.415248e-25,1.427235e-25,1.439169e-25,1.451049e-25,1.462873e-25,1.474643e-25,1.486358e-25,1.498016e-25,1.509618e-25,1.521163e-25,1.532651e-25,1.544081e-25,1.555453e-25,1.566767e-25,1.578021e-25,1.589216e-25,1.600351e-25,1.611426e-25,1.622441e-25,1.633394e-25,1.644286e-25,1.655116e-25,1.665883e-25,1.676588e-25,1.687230e-25,1.697808e-25,1.708322e-25,1.718772e-25,1.729157e-25,1.739477e-25,1.749732e-25,1.759920e-25,1.770043e-25,1.780099e-25,1.790088e-25,1.800009e-25,1.809863e-25,1.819648e-25,1.829365e-25,1.839013e-25,1.848592e-25,1.858101e-25,1.867541e-25,1.876910e-25,1.886208e-25,1.895435e-25,1.904591e-25,1.913676e-25,1.922688e-25,1.931628e-25,1.940495e-25,1.949289e-25,1.958009e-25,1.966656e-25,1.975229e-25,1.983728e-25,1.992152e-25,2.000501e-25,2.008774e-25,2.016972e-25,2.025094e-25,2.033140e-25,2.041109e-25,2.049001e-25,2.056816e-25,2.064554e-25,2.072214e-25,2.079796e-25,2.087300e-25,2.094725e-25,2.102071e-25,2.109338e-25,2.116526e-25,2.123634e-25,2.130662e-25,2.137610e-25,2.144477e-25,2.151264e-25,2.157969e-25,2.164594e-25,2.171136e-25,2.177598e-25,2.183977e-25,2.190274e-25,2.196488e-25,2.202620e-25,2.208669e-25,2.214634e-25,2.220517e-25,2.226315e-25,2.232030e-25,2.237661e-25,2.243208e-25,2.248670e-25,2.254047e-25,2.259340e-25,2.264547e-25,2.269670e-25,2.274706e-25,2.279658e-25,2.284523e-25,2.289302e-25,2.293995e-25,2.298602e-25,2.303123e-25,2.307556e-25,2.311903e-25,2.316162e-25,2.320335e-25,2.324420e-25,2.328417e-25,2.332327e-25,2.336149e-25,2.339883e-25,2.343530e-25,2.347087e-25,2.350557e-25,2.353938e-25,2.357230e-25,2.360434e-25,2.363548e-25,2.366574e-25,2.369511e-25,2.372358e-25,2.375116e-25,2.377785e-25,2.380364e-25,2.382853e-25,2.385253e-25,2.387563e-25,2.389783e-25,2.391913e-25,2.393953e-25,2.395903e-25,2.397763e-25,2.399533e-25,2.401212e-25,2.402800e-25,2.404299e-25,2.405706e-25,2.407023e-25,2.408250e-25,2.409386e-25,2.410431e-25,2.411385e-25,2.412249e-25,2.413022e-25,2.413704e-25,2.414295e-25,2.414795e-25,2.415204e-25,2.415523e-25,2.415750e-25,2.415886e-25,2.415932e-25,2.415886e-25,2.415750e-25,2.415523e-25,2.415204e-25,2.414795e-25,2.414295e-25,2.413704e-25,2.413022e-25,2.412249e-25,2.411385e-25,2.410431e-25,2.409386e-25,2.408250e-25,2.407023e-25,2.405706e-25,2.404299e-25,2.402800e-25,2.401212e-25,2.399533e-25,2.397763e-25,2.395903e-25,2.393953e-25,2.391913e-25,2.389783e-25,2.387563e-25,2.385253e-25,2.382853e-25,2.380364e-25,2.377785e-25,2.375116e-25,2.372358e-25,2.369511e-25,2.366574e-25,2.363548e-25,2.360434e-25,2.357230e-25,2.353938e-25,2.350557e-25,2.347087e-25,2.343530e-25,2.339883e-25,2.336149e-25,2.332327e-25,2.328417e-25,2.324420e-25,2.320335e-25,2.316162e-25,2.311903e-25,2.307556e-25,2.303123e-25,2.298602e-25,2.293995e-25,2.289302e-25,2.284523e-25,2.279658e-25,2.274706e-25,2.269670e-25,2.264547e-25,2.259340e-25,2.254047e-25,2.248670e-25,2.243208e-25,2.237661e-25,2.232030e-25,2.226315e-25,2.220517e-25,2.214634e-25,2.208669e-25,2.202620e-25,2.196488e-25,2.190274e-25,2.183977e-25,2.177598e-25,2.171136e-25,2.164594e-25,2.157969e-25,2.151264e-25,2.144477e-25,2.137610e-25,2.130662e-25,2.123634e-25,2.116526e-25,2.109338e-25,2.102071e-25,2.094725e-25,2.087300e-25,2.079796e-25,2.072214e-25,2.064554e-25,2.056816e-25,2.049001e-25,2.041109e-25,2.033140e-25,2.025094e-25,2.016972e-25,2.008774e-25,2.000501e-25,1.992152e-25,1.983728e-25,1.975229e-25,1.966656e-25,1.958009e-25,1.949289e-25,1.940495e-25,1.931628e-25,1.922688e-25,1.913676e-25,1.904591e-25,1.895435e-25,1.886208e-25,1.876910e-25,1.867541e-25,1.858101e-25,1.848592e-25,1.839013e-25,1.829365e-25,1.819648e-25,1.809863e-25,1.800009e-25,1.790088e-25,1.780099e-25,1.770043e-25,1.759920e-25,1.749732e-25,1.739477e-25,1.729157e-25,1.718772e-25,1.708322e-25,1.697808e-25,1.687230e-25,1.676588e-25,1.665883e-25,1.655116e-25,1.644286e-25,1.633394e-25,1.622441e-25,1.611426e-25,1.600351e-25,1.589216e-25,1.578021e-25,1.566767e-25,1.555453e-25,1.544081e-25,1.532651e-25,1.521163e-25,1.509618e-25,1.498016e-25,1.486358e-25,1.474643e-25,1.462873e-25,1.451049e-25,1.439169e-25,1.427235e-25,1.415248e-25,1.403207e-25,1.391113e-25,1.378967e-25,1.366770e-25,1.354520e-25,1.342220e-25,1.329869e-25,1.317468e-25,1.305018e-25,1.292518e-25,1.279970e-25,1.267373e-25,1.254729e-25,1.242037e-25,1.229299e-25,1.216514e-25,1.203684e-25,1.190809e-25,1.177888e-25,1.164923e-25,1.151915e-25,1.138862e-25,1.125768e-25,1.112630e-25,1.099451e-25,1.086230e-25,1.072969e-25,1.059667e-25,1.046325e-25,1.032944e-25,1.019524e-25,1.006065e-25,9.925692e-26,9.790354e-26,9.654649e-26,9.518580e-26,9.382152e-26,9.245371e-26,9.108243e-26,8.970771e-26,8.832961e-26,8.694819e-26,8.556350e-26,8.417558e-26,8.278450e-26,8.139030e-26,7.999303e-26,7.859275e-26,7.718952e-26,7.578337e-26,7.437438e-26,7.296258e-26,7.154804e-26,7.013080e-26,6.871093e-26,6.728846e-26,6.586347e-26,6.443599e-26,6.300608e-26,6.157381e-26,6.013922e-26,5.870236e-26,5.726329e-26,5.582207e-26,5.437874e-26,5.293337e-26,5.148600e-26,5.003670e-26,4.858551e-26,4.713249e-26,4.567770e-26,4.422119e-26,4.276302e-26,4.130323e-26,3.984189e-26,3.837905e-26,3.691476e-26,3.544908e-26,3.398207e-26,3.251378e-26,3.104427e-26,2.957359e-26,2.810179e-26,2.662894e-26,2.515508e-26,2.368027e-26,2.220458e-26,2.072805e-26,1.925073e-26,1.777270e-26,1.629399e-26,1.481467e-26,1.333480e-26,1.185442e-26,1.037359e-26,8.892375e-27,7.410824e-27,5.928994e-27,4.446941e-27,2.964720e-27,1.482388e-27,-7.770230e-41,-1.482388e-27,-2.964720e-27,-4.446941e-27,-5.928994e-27,-7.410824e-27,-8.892375e-27,-1.037359e-26,-1.185442e-26,-1.333480e-26,-1.481467e-26,-1.629399e-26,-1.777270e-26,-1.925073e-26,-2.072805e-26,-2.220458e-26,-2.368027e-26,-2.515508e-26,-2.662894e-26,-2.810179e-26,-2.957359e-26,-3.104427e-26,-3.251378e-26,-3.398207e-26,-3.544908e-26,-3.691476e-26,-3.837905e-26,-3.984189e-26,-4.130323e-26,-4.276302e-26,-4.422119e-26,-4.567770e-26,-4.713249e-26,-4.858551e-26,-5.003670e-26,-5.148600e-26,-5.293337e-26,-5.437874e-26,-5.582207e-26,-5.726329e-26,-5.870236e-26,-6.013922e-26,-6.157381e-26,-6.300608e-26,-6.443599e-26,-6.586347e-26,-6.728846e-26,-6.871093e-26,-7.013080e-26,-7.154804e-26,-7.296258e-26,-7.437438e-26,-7.578337e-26,-7.718952e-26,-7.859275e-26,-7.999303e-26,-8.139030e-26,-8.278450e-26,-8.417558e-26,-8.556350e-26,-8.694819e-26,-8.832961e-26,-8.970771e-26,-9.108243e-26,-9.245371e-26,-9.382152e-26,-9.518580e-26,-9.654649e-26,-9.790354e-26,-9.925692e-26,-1.006065e-25,-1.019524e-25,-1.032944e-25,-1.046325e-25,-1.059667e-25,-1.072969e-25,-1.086230e-25,-1.099451e-25,-1.112630e-25,-1.125768e-25,-1.138862e-25,-1.151915e-25,-1.164923e-25,-1.177888e-25,-1.190809e-25,-1.203684e-25,-1.216514e-25,-1.229299e-25,-1.242037e-25,-1.254729e-25,-1.267373e-25,-1.279970e-25,-1.292518e-25,-1.305018e-25,-1.317468e-25,-1.329869e-25,-1.342220e-25,-1.354520e-25,-1.366770e-25,-1.378967e-25,-1.391113e-25,-1.403207e-25,-1.415248e-25,-1.427235e-25,-1.439169e-25,-1.451049e-25,-1.462873e-25,-1.474643e-25,-1.486358e-25,-1.498016e-25,-1.509618e-25,-1.521163e-25,-1.532651e-25,-1.544081e-25,-1.555453e-25,-1.566767e-25,-1.578021e-25,-1.589216e-25,-1.600351e-25,-1.611426e-25,-1.622441e-25,-1.633394e-25,-1.644286e-25,-1.655116e-25,-1.665883e-25,-1.676588e-25,-1.687230e-25,-1.697808e-25,-1.708322e-25,-1.718772e-25,-1.729157e-25,-1.739477e-25,-1.749732e-25,-1.759920e-25,-1.770043e-25,-1.780099e-25,-1.790088e-25,-1.800009e-25,-1.809863e-25,-1.819648e-25,-1.829365e-25,-1.839013e-25,-1.848592e-25,-1.858101e-25,-1.867541e-25,-1.876910e-25,-1.886208e-25,-1.895435e-25,-1.904591e-25,-1.913676e-25,-1.922688e-25,-1.931628e-25,-1.940495e-25,-1.949289e-25,-1.958009e-25,-1.966656e-25,-1.975229e-25,-1.983728e-25,-1.992152e-25,-2.000501e-25,-2.008774e-25,-2.016972e-25,-2.025094e-25,-2.033140e-25,-2.041109e-25,-2.049001e-25,-2.056816e-25,-2.064554e-25,-2.072214e-25,-2.079796e-25,-2.087300e-25,-2.094725e-25,-2.102071e-25,-2.109338e-25,-2.116526e-25,-2.123634e-25,-2.130662e-25,-2.137610e-25,-2.144477e-25,-2.151264e-25,-2.157969e-25,-2.164594e-25,-2.171136e-25,-2.177598e-25,-2.183977e-25,-2.190274e-25,-2.196488e-25,-2.202620e-25,-2.208669e-25,-2.214634e-25,-2.220517e-25,-2.226315e-25,-2.232030e-25,-2.237661e-25,-2.243208e-25,-2.248670e-25,-2.254047e-25,-2.259340e-25,-2.264547e-25,-2.269670e-25,-2.274706e-25,-2.279658e-25,-2.284523e-25,-2.289302e-25,-2.293995e-25,-2.298602e-25,-2.303123e-25,-2.307556e-25,-2.311903e-25,-2.316162e-25,-2.320335e-25,-2.324420e-25,-2.328417e-25,-2.332327e-25,-2.336149e-25,-2.339883e-25,-2.343530e-25,-2.347087e-25,-2.350557e-25,-2.353938e-25,-2.357230e-25,-2.360434e-25,-2.363548e-25,-2.366574e-25,-2.369511e-25,-2.372358e-25,-2.375116e-25,-2.377785e-25,-2.380364e-25,-2.382853e-25,-2.385253e-25,-2.387563e-25,-2.389783e-25,-2.391913e-25,-2.393953e-25,-2.395903e-25,-2.397763e-25,-2.399533e-25,-2.401212e-25,-2.402800e-25,-2.404299e-25,-2.405706e-25,-2.407023e-25,-2.408250e-25,-2.409386e-25,-2.410431e-25,-2.411385e-25,-2.412249e-25,-2.413022e-25,-2.413704e-25,-2.414295e-25,-2.414795e-25,-2.415204e-25,-2.415523e-25,-2.415750e-25,-2.415886e-25,-2.415932e-25,-2.415886e-25,-2.415750e-25,-2.415523e-25,-2.415204e-25,-2.414795e-25,-2.414295e-25,-2.413704e-25,-2.413022e-25,-2.412249e-25,-2.411385e-25,-2.410431e-25,-2.409386e-25,-2.408250e-25,-2.407023e-25,-2.405706e-25,-2.404299e-25,-2.402800e-25,-2.401212e-25,-2.399533e-25,-2.397763e-25,-2.395903e-25,-2.393953e-25,-2.391913e-25,-2.389783e-25,-2.387563e-25,-2.385253e-25,-2.382853e-25,-2.380364e-25,-2.377785e-25,-2.375116e-25,-2.372358e-25,-2.369511e-25,-2.366574e-25,-2.363548e-25,-2.360434e-25,-2.357230e-25,-2.353938e-25,-2.350557e-25,-2.347087e-25,-2.343530e-25,-2.339883e-25,-2.336149e-25,-2.332327e-25,-2.328417e-25,-2.324420e-25,-2.320335e-25,-2.316162e-25,-2.311903e-25,-2.307556e-25,-2.303123e-25,-2.298602e-25,-2.293995e-25,-2.289302e-25,-2.284523e-25,-2.279658e-25,-2.274706e-25,-2.269670e-25,-2.264547e-25,-2.259340e-25,-2.254047e-25,-2.248670e-25,-2.243208e-25,-2.237661e-25,-2.232030e-25,-2.226315e-25,-2.220517e-25,-2.214634e-25,-2.208669e-25,-2.202620e-25,-2.196488e-25,-2.190274e-25,-2.183977e-25,-2.177598e-25,-2.171136e-25,-2.164594e-25,-2.157969e-25,-2.151264e-25,-2.144477e-25,-2.137610e-25,-2.130662e-25,-2.123634e-25,-2.116526e-25,-2.109338e-25,-2.102071e-25,-2.094725e-25,-2.087300e-25,-2.079796e-25,-2.072214e-25,-2.064554e-25,-2.056816e-25,-2.049001e-25,-2.041109e-25,-2.033140e-25,-2.025094e-25,-2.016972e-25,-2.008774e-25,-2.000501e-25,-1.992152e-25,-1.983728e-25,-1.975229e-25,-1.966656e-25,-1.958009e-25,-1.949289e-25,-1.940495e-25,-1.931628e-25,-1.922688e-25,-1.913676e-25,-1.904591e-25,-1.895435e-25,-1.886208e-25,-1.876910e-25,-1.867541e-25,-1.858101e-25,-1.848592e-25,-1.839013e-25,-1.829365e-25,-1.819648e-25,-1.809863e-25,-1.800009e-25,-1.790088e-25,-1.780099e-25,-1.770043e-25,-1.759920e-25,-1.749732e-25,-1.739477e-25,-1.729157e-25,-1.718772e-25,-1.708322e-25,-1.697808e-25,-1.687230e-25,-1.676588e-25,-1.665883e-25,-1.655116e-25,-1.644286e-25,-1.633394e-25,-1.622441e-25,-1.611426e-25,-1.600351e-25,-1.589216e-25,-1.578021e-25,-1.566767e-25,-1.555453e-25,-1.544081e-25,-1.532651e-25,-1.521163e-25,-1.509618e-25,-1.498016e-25,-1.486358e-25,-1.474643e-25,-1.462873e-25,-1.451049e-25,-1.439169e-25,-1.427235e-25,-1.415248e-25,-1.403207e-25,-1.391113e-25,-1.378967e-25,-1.366770e-25,-1.354520e-25,-1.342220e-25,-1.329869e-25,-1.317468e-25,-1.305018e-25,-1.292518e-25,-1.279970e-25,-1.267373e-25,-1.254729e-25,-1.242037e-25,-1.229299e-25,-1.216514e-25,-1.203684e-25,-1.190809e-25,-1.177888e-25,-1.164923e-25,-1.151915e-25,-1.138862e-25,-1.125768e-25,-1.112630e-25,-1.099451e-25,-1.086230e-25,-1.072969e-25,-1.059667e-25,-1.046325e-25,-1.032944e-25,-1.019524e-25,-1.006065e-25,-9.925692e-26,-9.790354e-26,-9.654649e-26,-9.518580e-26,-9.382152e-26,-9.245371e-26,-9.108243e-26,-8.970771e-26,-8.832961e-26,-8.694819e-26,-8.556350e-26,-8.417558e-26,-8.278450e-26,-8.139030e-26,-7.999303e-26,-7.859275e-26,-7.718952e-26,-7.578337e-26,-7.437438e-26,-7.296258e-26,-7.154804e-26,-7.013080e-26,-6.871093e-26,-6.728846e-26,-6.586347e-26,-6.443599e-26,-6.300608e-26,-6.157381e-26,-6.013922e-26,-5.870236e-26,-5.726329e-26,-5.582207e-26,-5.437874e-26,-5.293337e-26,-5.148600e-26,-5.003670e-26,-4.858551e-26,-4.713249e-26,-4.567770e-26,-4.422119e-26,-4.276302e-26,-4.130323e-26,-3.984189e-26,-3.837905e-26,-3.691476e-26,-3.544908e-26,-3.398207e-26,-3.251378e-26,-3.104427e-26,-2.957359e-26,-2.810179e-26,-2.662894e-26,-2.515508e-26,-2.368027e-26,-2.220458e-26,-2.072805e-26,-1.925073e-26,-1.777270e-26,-1.629399e-26,-1.481467e-26,-1.333480e-26,-1.185442e-26,-1.037359e-26,-8.892375e-27,-7.410824e-27,-5.928994e-27,-4.446941e-27,-2.964720e-27,-1.482388e-27
};

void BSP_Setfreq(float f)
{
	if(f>40000.0f)
		f = 40000.0f;
	if(f<0.0f)
		f = 0.0f;
	freq = f;
	Wave_tick1 = 42949.673f * f;
}

void HAL_I2S_TxHalfCpltCallback(I2S_HandleTypeDef *hi2s)
{
	uint16_t i,tmp;
//	HAL_GPIO_WritePin(GPIOB,GPIO_PIN_12,GPIO_PIN_SET);
	for(i=1;i<=1024;i+=2)
	{
		tmp = Wave_sum1>>22;	//10bit
		Wave_sum1 += Wave_tick1;
		
		I2S_DACBuf[i] = twiddleCoefQ15[tmp];
		fifo[0][i>>1] = I2S_ADCBuf[i-1];
		fifo[1][i>>1] = I2S_ADCBuf[i];
		fifo[2][i>>1] = twiddleCoeff32[tmp];
		fifo[3][i>>1] = twiddleCoeff32[(tmp+768)&0x3ff];		//2^10=1024
	}
	
	DSP_I2S_Callback(fifo[0], fifo[1], fifo[2], fifo[3], 0);
//	HAL_GPIO_WritePin(GPIOB,GPIO_PIN_12,GPIO_PIN_RESET);
}

void HAL_I2S_TxCpltCallback(I2S_HandleTypeDef *hi2s)
{
	uint16_t i,tmp;
//	HAL_GPIO_WritePin(GPIOB,GPIO_PIN_12,GPIO_PIN_SET);
	for(i=1024+1;i<=2048;i+=2)
	{
		tmp = Wave_sum1>>22;
		Wave_sum1 += Wave_tick1;
		
		I2S_DACBuf[i] = twiddleCoefQ15[tmp];
		fifo[0][i>>1] = I2S_ADCBuf[i-1];
		fifo[1][i>>1] = I2S_ADCBuf[i];
		fifo[2][i>>1] = twiddleCoeff32[tmp];
		fifo[3][i>>1] = twiddleCoeff32[(tmp+768)&0x3ff];		//2^10=1024
	}
	
	DSP_I2S_Callback(fifo[0], fifo[1], fifo[2], fifo[3], 512);
//	HAL_GPIO_WritePin(GPIOB,GPIO_PIN_12,GPIO_PIN_RESET);
}

const uint8_t CodecInit[][2] = 
{
	/* DAC Step */
	{0x00,0x00},	//Select Page 0
	{0x0b,0x81},	//NDAC = 1,Power up
	{0x0c,0x82},	//MDAC = 2,Power up
	{0x0d,0x00},	//DOSR = 128
	{0x0e,0x80},	//DOSR LSB
	{0x3c,0x01},	//PRB_P1
	
	/* ADC Step */
	{0x12,0x81},	//NADC = 1,Power up
	{0x13,0x82},	//MADC = 2,Power up
	{0x14,0x80},	//AOSR = 128
	{0x3d,0x01},	//PRB_R1
	
	/* Audio Interface */
	{0x1b,0x00},	//16bit,PTM_P4
	
	/* Power Step */
	{0x00,0x01},	//Select Page 1
	{0x01,0x08},	//Disabled weak connection of AVDD with DVDD
	{0x02,0x01},	//Analog Block Power up,AVDD LDO Power up
	//{0x0a,0x3b},	//Input Vcom = 0.9v,Output Vcom = 1.65v
	{0x0a,0x03},
	
	{0x03,0x00},	//DAC PTM mode		to PTM_P3/4
	{0x04,0x00},
	{0x3d,0x00},	//ADC PTM mode		to PTM_R4
	
//	{0x7b,0x01},	//REF settime			to 40ms
//	{0x14,0x25},	//HP settime			to	
	
	/* Input Step */
	{0x34,0x10},	//Route IN2L to LEFT_P with 10k
	{0x36,0x10},	//Route IN2R to LEFT_M with 10k
	{0x37,0x40},	//Route IN1R to RIGHT_P with 10k
	{0x39,0x10},	//Route IN1L to RIGHT_M with 10k
	
	{0x3b,0x00},	//Left  MicPGA not mute,gain to 0dB
	{0x3c,0x00},	//Right MicPGA not mute,gain to 0dB
	{0x53,0x00},	//Left  ADC Digital gain
	{0x54,0x00},	//Right ADC Digital gain
	
	/* Output Step */
	{0x0c,0x08},	//Route Left  DAC to HPL
	{0x0d,0x08},	//Route Right DAC to HPR
	{0x0e,0x08},	//Route Left  DAC to LOL
	{0x0f,0x08},	//Route Right DAC to LOR
	
	{0x10,0x00},	//HPL gain	to 0dB
	{0x11,0x00},	//HPR gain	to 0dB
	{0x12,0x08},	//LOL gain	to 0dB
	{0x13,0x08},	//LOR gain	to 0dB
	
	{0x16,0x75},
	{0x17,0x75},
	
	{0x09,0x3c},	//LOL,LOR,HPL,HPR,Power up
	
	/* Initial ok */
	{0x00,0x00},	//Select Page 0
	{0x3f,0xd6},	//L&R DAC Power up
	{0x40,0x00},	//L&R DAC not mute
	{0x51,0xc0},	//L&R ADC Power up
	{0x52,0x00},	//L&R ADC not mute
};

void BSP_CODEC_Init(void)
{
	uint16_t size = sizeof(CodecInit)/sizeof(CodecInit[0][0])/2;
	uint16_t i;

	//hi2s3.Instance->I2SPR = 0x0205;
	BSP_Setfreq(freq);
	
	/* TLV320AIC3204 reset */	
	Single_WriteI2C(0x00, 0x00);
	Single_WriteI2C(0x01, 0x01);
	
	HAL_Delay(5);
	
	for(i=0;i<size;i++)
			Single_WriteI2C(CodecInit[i][0],CodecInit[i][1]);
}

void BSP_CODEC_Start(void)
{
	HAL_I2SEx_TransmitReceive_DMA(&hi2s3,(uint16_t *)&I2S_DACBuf,(uint16_t *)&I2S_ADCBuf,2048);
}

void Single_WriteI2C(uint8_t REG_Address,uint8_t REG_data)
{
    uint8_t txData[2] = {REG_Address,REG_data};
    while(HAL_I2C_Master_Transmit(&hi2c1,I2C_ADDRESS,txData,2,100) != HAL_OK)
    {
        if(HAL_I2C_GetError(&hi2c1) != HAL_I2C_ERROR_AF)
        {}
    }
}
uint8_t Single_ReadI2C(uint8_t REG_Address)
{
    uint8_t REG_data;
    while(HAL_I2C_Master_Transmit(&hi2c1,I2C_ADDRESS,&REG_Address,1,100) != HAL_OK)
    {
        if(HAL_I2C_GetError(&hi2c1) != HAL_I2C_ERROR_AF)
        {}
    }
    
    if(HAL_I2C_Master_Receive(&hi2c1,I2C_ADDRESS+1,&REG_data,1,100) != HAL_OK)
    {
        if(HAL_I2C_GetError(&hi2c1) != HAL_I2C_ERROR_AF)
        {}
    }
    return REG_data;
}
